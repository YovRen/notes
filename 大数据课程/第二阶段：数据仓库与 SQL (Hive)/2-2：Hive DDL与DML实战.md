你好！欢迎来到 **2-2** 课。

如果说上一节课是学会了“造房子”（建表），那这一节课我们要学习“造什么样的房子最安全、最实用”。

在企业级开发中，**99% 的表都是外部表，99% 的大表都是分区表**。不理解这两个概念，你的 Hive 脚本一上线就会被运维打回来。

---

### 1. 核心对比：内部表 vs 外部表 (The "Rent vs. Buy" Analogy)

这是 Hive 设计最独特，也是面试官最爱问的地方。

#### 🏠 类比：住酒店 vs 租房子

1. **内部表 (Internal/Managed Table)** —— **像住酒店**

   * **关系**：你和房间是强绑定的。
   * **退房（删除表）**：当你办理退房（执行 `DROP TABLE`）时，酒店服务员会把房间打扫得干干净净，把你留下的所有东西（数据）都扔掉。
   * **后果**：**元数据（表结构）没了，HDFS 上的真实数据文件也没了。**
2. **外部表 (External Table)** —— **像租空房子**

   * **关系**：房子（HDFS文件）本身就在那里，你只是签了个合同（元数据）搬进去住。
   * **退房（删除表）**：当你解约（执行 `DROP TABLE`）时，你只是撕毁了合同。房子本身（HDFS数据）还在那里，完好无损，下一个人还可以签合同接着用。
   * **后果**：**元数据（表结构）没了，但 HDFS 上的真实数据文件还在！**

#### 🛡️ 企业为什么只用外部表？

想象一下，几个 T 的核心交易数据，实习生手一抖写了个 `DROP TABLE`...

* 如果是内部表：**灾难**（数据物理删除，很难恢复）。
* 如果是外部表：**小事**（只是映射关系断了，重新 `CREATE EXTERNAL TABLE` 连上去就行）。

---

### 2. 性能优化核心：分区表 (Partition)

#### 📂 什么是分区？

不要把分区想得太复杂，它在 HDFS 上本质上就是**文件夹**。

* **没有分区**：所有数据混在一起。
  * HDFS 路径：`/user/hive/warehouse/logs/data_all.txt`
* **按天分区**：每天的数据放在一个独立的文件夹里。
  * HDFS 路径：`/user/hive/warehouse/logs/dt=2023-01-01/data.txt`
  * HDFS 路径：`/user/hive/warehouse/logs/dt=2023-01-02/data.txt`

#### 🚀 为什么要分区？（避免全表扫描）

假设你要查询“2023-01-01”当天的订单：

* **不分区**：Hive 必须要把整个文件夹里 **10 年** 的数据全读一遍，然后一行行检查日期是不是今天。这叫**全表扫描 (Full Table Scan)**，慢得令人发指。
* **有分区**：Hive 看到你的 SQL 里写了 `WHERE dt='2023-01-01'`，它会**直接定位**到那个特定的文件夹，其他文件夹看都不看。速度提升 100 倍。

---

### 3. 代码实操：外部表 + 分区

我们来创建一个电商日志表，要求是**外部表**，且**按日期分区**。

#### 第一步：编写建表语句 (DDL)

```sql
-- 关键字 EXTERNAL: 声明这是外部表
CREATE EXTERNAL TABLE order_logs (
    order_id STRING,
    user_id INT,
    amount DOUBLE
)
-- 关键字 PARTITIONED BY: 声明分区字段
-- 注意：dt (日期) 不需要在上面的列里重复定义，它是一个"虚拟列"
PARTITIONED BY (dt STRING)
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
-- 这里可以指定 HDFS 路径，如果不指定，默认在 Hive 仓库目录下
LOCATION '/data/order_logs';
```

#### 第二步：准备数据与加载 (DML)

假设我们要分别导入两天的数据。

1. **准备本地文件** `logs_01.txt`:

   ```text
   1001,Jack,50.5
   1002,Rose,30.0
   ```

2. **准备本地文件** `logs_02.txt`:

   ```text
   1003,Tom,20.0
   1004,Jerry,15.5
   ```

3. **加载数据（一定要指定分区！）**:

   ```sql
   -- 导入 1月1日的数据
   LOAD DATA LOCAL INPATH '/路径/logs_01.txt' 
   INTO TABLE order_logs 
   PARTITION (dt='2023-01-01');

   -- 导入 1月2日的数据
   LOAD DATA LOCAL INPATH '/路径/logs_02.txt' 
   INTO TABLE order_logs 
   PARTITION (dt='2023-01-02');
   ```

#### 第三步：查询体验

```sql
-- 1. 全表查（自动显示 dt 列）
SELECT * FROM order_logs;

-- 2. 分区裁剪（Partition Pruning）—— 性能飞起！
-- 这一句只会扫描 1月1日 的文件夹
SELECT * FROM order_logs WHERE dt='2023-01-01';
```

---

### 4. 面试视角：直击痛点

**面试官问：** “请问 `DROP TABLE` 时，内部表和外部表的行为有什么区别？”

**你的满分回答：**

> “区别在于**元数据**和**原始数据**的生命周期管理。
>
> * 如果是**内部表 (Managed Table)**，Hive 会同时管理元数据和 HDFS 数据。Drop 时，**两者都会被删除**。
> * 如果是**外部表 (External Table)**，Hive 只管理元数据。Drop 时，只会删除 MySQL 里的元数据，**HDFS 上的实际文件会保留**。
> * 在生产环境中，为了数据安全，我们几乎全部使用外部表。”

---

### 5. 课后作业：架构设计题

为了验证你是否真的懂了分区，请思考下面这个场景：

**场景**：
你在做一个类似“美团外卖”的数据平台。每天有 **10 亿条** 订单日志。
你需要经常回答以下两个问题：

1. 查询**某一天**（比如昨天）的全平台订单总额。
2. 查询**北京地区**在**某一天**的订单总额。

**问题**：
请为这张表设计分区策略（`PARTITIONED BY ...`）。

1. 你会选择哪一列作为一级分区？
2. 你会设二级分区吗？如果会，谁是一级，谁是二级？为什么？

请回复你的设计思路。
