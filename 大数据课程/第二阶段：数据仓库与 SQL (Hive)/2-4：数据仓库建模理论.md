你好！欢迎来到 **2-4** 课。

这是第二阶段的最后一课，也是最“虚”但最“贵”的一课。
写 SQL 是**战术**（怎么实现），建数仓是**战略**（怎么设计）。一个好的数仓架构，能让原本跑 5 个小时的任务变成 30 分钟，也能让混乱的数据变得井井有条。

---

### 1. 核心通俗化：数仓分层（ODS -> DWD -> DWS -> ADS）

为什么要分层？为什么不直接从原始日志算出报表？
**因为“乱”和“复用性差”。** 如果每做一个报表都去读原始日志，一旦日志格式变了，几百个报表全都要重写。

我们用**“京东物流转运中心”**来类比这四层架构：

#### **第一层：ODS (Operational Data Store) —— 卸货区**

* **状态**：**原封不动**。
* **动作**：卡车把商家发来的包裹（原始日志/数据库数据）卸下来。
* **特点**：包裹可能破损、地址写错、有重复发货。我们**只管收，不许改**。
* **数据形态**：和业务数据库（MySQL）或日志文件完全一致。

#### **第二层：DWD (Data Warehouse Detail) —— 分拣清洗区**

* **状态**：**干净的明细**。
* **动作**：
  1. **清洗 (ETL)**：把破损的包裹剔除，把地址填错的修正（处理脏数据）。
  2. **规范化**：把“北京”统一改成“Beijing”，把时间戳转成“2023-10-01”（统一格式）。
* **核心**：**这里依然是一个个独立的包裹（明细数据），没有聚合。**
* **数据形态**：事实表（订单明细） + 维度表（用户表、商品表）。

#### **第三层：DWS (Data Warehouse Service) —— 打包区（大宽表）**

* **状态**：**按主题聚类**。
* **动作**：把发往“海淀区”的所有包裹打成一个大托盘；把“双11”的所有订单打成一个大包。
* **核心**：**轻度聚合**。我们开始把多张表拼在一起，形成一张**“大宽表”**。
* **数据形态**：比如“用户单日行为宽表”（包含 ID、登录次数、下单金额、退款金额...）。一行数据概括了一个人一天的所有事。

#### **第四层：ADS (Application Data Service) —— 发货单**

* **状态**：**最终结果**。
* **动作**：给老板看的报表，或者给前端页面展示的数据。
* **核心**：数据量很小，直接可以存入 MySQL 或 Redis。
* **数据形态**：比如“2023年Q1全国销售总额”、“Top10 败家用户”。

---

### 2. 概念辨析：星型模型 vs 雪花模型

在 **DWD 层**，我们需要把数据拆成 **事实表 (Fact)** 和 **维度表 (Dimension)**。怎么连这几张表，有两种流派。

#### 🌟 星型模型 (Star Schema) —— 大数据的主流

* **长相**：中间一张巨大的**事实表**（如订单），周围围着一圈**维度表**（用户、商品、时间）。像一颗星星。
* **特点**：
  * **扁平化**：维度表不准再连维度表。
  * **冗余**：为了少 Join，允许数据重复。比如商品表里直接存“一级分类名”，而不是存“分类ID”再去连分类表。
* **优点**：**查询速度快**（Join 次数少），逻辑简单。

#### ❄️ 雪花模型 (Snowflake Schema) —— 传统数据库的最爱

* **长相**：维度表外面还连着维度表。比如：订单 -> 商品 -> 二级分类 -> 一级分类。像雪花一样发散。
* **特点**：
  * **规范化**：数据不冗余，节省存储空间。
* **优点**：存得少。
* **缺点**：**在大数据里是灾难**。因为每一次 Join 都要触发 Shuffle（网络传输），雪花模型要连四五次，任务会跑死。

**结论**：**在大数据数仓里，99% 使用星型模型。** 空间不值钱，计算（时间）才值钱。

---

### 3. 实战视角：每层具体存什么？

* **ODS 层**：

  * 表名通常以 `ods_` 开头。
  * 通常是 `PARTITIONED BY (dt)` 按天分区。
  * 存储格式：TextFile 或 Parquet（压缩）。
* **DWD 层**（最累的一层）：

  * 表名以 `dwd_` 开头。
  * **ETL 清洗**就在这里做（比如用 Hive SQL 剔除 `amount < 0` 的脏数据）。
  * **维度退化**：把经常用的维度直接塞进事实表里。
* **DWS 层**（黄金层）：

  * 表名以 `dws_` 开头。
  * **大宽表 (Wide Table)**：这是最核心的资产。比如 `dws_user_action_day_count`。
  * 如果下游 10 个报表都要用到“用户性别”，不要在 ADS 层重复关联，直接在 DWS 层把性别拼进宽表里。
* **ADS 层**：

  * 表名以 `ads_` 或 `rpt_` 开头。
  * 结果通常只有几十行到几万行。
  * 会通过 Sqoop 或 DataX 导出到 MySQL 给可视化系统（如 Tableau, Superset, Echarts）读取。

---

### 4. 课后作业：架构设计师

**场景**：
你正在为“滴滴打车”设计数仓。我们需要出一个报表：**“北京市不同年龄段司机的日均接单量”**。

原始数据在 ODS 层有两张表：

1. `ods_order_info` (订单表)：`order_id`, `driver_id`, `city_id`, `amount`, `dt`
2. `ods_driver_info` (司机表)：`driver_id`, `driver_name`, `birthday`, `city_id`

**请设计数据流向（请文字描述每层做了什么）：**

1. **DWD 层**：你需要清洗什么？需要处理“年龄”吗？
2. **DWS 层**：你会构建一张什么样的主题宽表？（这一步最关键，决定了计算快慢）
3. **ADS 层**：最终输出的字段有哪些？

请回复你的设计方案。
