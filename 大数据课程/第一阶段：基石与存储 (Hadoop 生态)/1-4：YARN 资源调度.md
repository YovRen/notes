你好！欢迎来到第一阶段的最后一课。

如果说 HDFS 是仓库（存东西），MapReduce 是工人的干活方式（搬砖逻辑），那么 **YARN (Yet Another Resource Negotiator)** 就是这家工厂的 **“大管家”** 或 **“操作系统”**。

在 Hadoop 2.0 之前，没有 YARN，MapReduce 既管干活又管资源，累得要死。现在，YARN 专门负责分配资源（内存、CPU），让 Spark、Flink、MapReduce 都能在一个集群上和谐共处。

---

### 1. 核心通俗化：大数据“外包公司”的人力资源部

把整个大数据集群看作一家**大型外包公司**。

* **集群资源（内存/CPU）** = **公司的流动资金和空闲工位**。
* **计算任务（Job）** = **接到的项目**（比如“统计双11销售额”）。

在这个公司里，有三个核心角色：

1. **ResourceManager (RM) —— 总部 HR 总监（掌握大权）**

   * **位置**：坐在总部（Master 节点）。
   * **职责**：他是上帝视角。他知道全公司一共有多少钱、多少个工位。所有项目经理都要向他申请资源。
   * *口头禅*：“现在公司资源紧张，只剩 10G 内存了，在这个队列里排队等着！”
2. **NodeManager (NM) —— 分公司经理（管好一亩三分地）**

   * **位置**：分布在各个干活的节点上（Worker 节点）。
   * **职责**：管理自己这台机器上的资源。如果这台机器有 64G 内存，他负责切分给不同的任务，并向总部 HR 汇报心跳：“老板，我这儿还活著，还有空位！”
3. **ApplicationMaster (AM) —— 项目经理（临时工头）**

   * **职责**：每当你提交一个任务，YARN 就会先启动一个 AM。AM 负责去向 RM 申请资源，然后指挥 NM 干活。
   * *流程*：AM 拿着 RM 给的“批条”，跑到 NM 那里说：“给我开两个工位，我要跑代码！”

---

### 2. 架构解析：什么是 Container（容器）？

这不是 Docker 的容器，而是 YARN 里的一个逻辑概念。

**想象一下架构图：**

```text
       +-----------------------+
       |   ResourceManager (RM)| <--- 1. 统筹全局，接收任务
       +-----------+-----------+
                   | (心跳汇报/下达指令)
        /          |           \
+-------+--+   +---+------+   +--+-------+
|NodeManager|  |NodeManager|  |NodeManager|
| [Container]|  | [Container]|  |           |
| [Container]|  |           |  | [Container]|
+----------+   +----------+   +----------+
```

**核心概念：Container（封装资源的箱子）**

* 当 MapReduce 或 Spark 需要跑代码时，它不能直接占用整台机器。
* NodeManager 会在机器上画一个圈，说：“这个圈里有 **1核CPU + 2G内存**，你就在这里面跑，敢超出去我就把你杀掉（Kill）。”
* 这个圈，就是 **Container**。
* **总结**：**Container 是 YARN 分配资源的最小单位。**

---

### 3. 面试与实战视角

**Q1: 任务卡在 "ACCEPTED" 状态不动了，怎么办？**

* **现象**：你提交了一个 Spark 任务，进度条一直是 0%，状态显示 `ACCEPTED`，而不是 `RUNNING`。
* **原因**：**资源不够了！** 或者你所在的“队列”满了。
* **解决**：
  1. 等别的任务跑完。
  2. 杀掉（Kill）一些不重要的任务腾出资源。
  3. 检查是否有人占着茅坑不拉屎（代码写了死循环）。

**Q2: 什么是“资源队列 (Scheduler Queue)”？（必考）**

* **场景**：公司里有“数据分析组”和“机器学习组”。不能让机器学习组把资源全占光，导致分析组连报表都跑不出来。
* **方案**：YARN 配置**多队列**。
  * `Queue A (Analytics)`：占 30% 资源。
  * `Queue B (ML)`：占 70% 资源。
  * 任务提交时必须指定队列，各用各的，互不干扰。这就叫 **Capacity Scheduler（容量调度器）**。

**Q3: 任务跑挂了，怎么看日志？**

* **坑**：任务是在某台分公司机器（NodeManager）上跑的，日志也在那台机器上。任务挂了，那台容器可能都销毁了。
* **解法**：YARN 提供了**日志聚合 (Log Aggregation)** 功能。它会把散落在各地的日志收集起来，传到 HDFS 上。你只需要用命令 `yarn logs` 就能统一查看。

---

### 4. 操作演示：YARN 常用命令

请在你的 Docker 环境中尝试运行（如果容器中没有启动 yarn，可能需要先运行 `/usr/local/hadoop/sbin/start-yarn.sh`，具体视镜像而定，不过通常 `yarn` 命令是可用的）。

```bash
# 1. 查看这台机器上所有的节点 (看看谁活着)
yarn node -list

# 2. 查看当前正在运行的任务 (最常用)
yarn application -list

# 3. 杀死一个有问题的任务 (假设 Application ID 是 application_123_001)
# 只有把任务杀掉，资源才会释放出来
# yarn application -kill application_123_001  <-- 别真运行，除非你有任务

# 4. 查看任务日志 (找报错专用)
# yarn logs -applicationId application_123_001
```

---

### 5. 课后作业：资源分配算术题

为了验证你对 YARN 资源调度的理解，请做一道真实的**容量规划题**：

**场景**：
你的集群一共有 **3台** 机器（NodeManager）。
每台机器配置是：**16GB 内存**，**4核 CPU**。
为了保证系统稳定，每台机器预留 4GB 给操作系统，剩下的给 YARN。

**问题**：

1. 整个 YARN 集群一共有多少**可用内存**？
2. 现在来了一个大任务，需要申请 **10个** Container，每个 Container 需要 **2GB** 内存。
3. 这个集群能装下这个任务吗？还剩多少内存？

请把计算过程和答案发给我。
